name: Regen lockfile

on:
  workflow_dispatch:
  pull_request:
    types: [opened]

permissions:
  contents: write

jobs:
  regen-lockfile:
    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(fromJSON('["renovate[bot]"]'), github.actor)
    runs-on: ubuntu-latest
    env:
      IS_INTERNAL_PR: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
      GIT_AUTHOR_NAME: 'Stryker Bot'
      GIT_AUTHOR_EMAIL: 'strykermutator.npa@gmail.com'
      GIT_COMMITTER_NAME: 'Stryker Bot'
      GIT_COMMITTER_EMAIL: 'strykermutator.npa@gmail.com'

    steps:
      - name: Ensure this job is allowed to use secrets
        if: env.IS_INTERNAL_PR != 'true'
        run: |
          echo "This workflow only pushes from same-repo branches or manual runs."
          exit 0

      - name: Checkout (with NPA PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.STRYKER_MUTATOR_NPA_KEY }}
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Sync to latest branch tip
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ github.head_ref || github.ref_name }}"
          git fetch origin "$REF"
          git switch -C "$REF" "origin/$REF"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Clean install & regenerate lockfile
        shell: bash
        run: |
          set -euo pipefail
          rm -rf node_modules packages/*/node_modules package-lock.json
          npm i

      - name: Commit changes if package-lock.json changed
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet -- package-lock.json; then
            echo "No lockfile changes detected. Nothing to commit."
            exit 0
          fi

          git config user.name  "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

          git add package-lock.json
          git commit -m "Regen lockfile"

          # Ensure pushes go over HTTPS with the NPA PAT
          git remote set-url origin "https://x-access-token:${{ secrets.NPA_PAT }}@github.com/${{ github.repository }}.git"

          REF="${{ github.head_ref || github.ref_name }}"
          git push --force-with-lease origin "HEAD:${REF}"

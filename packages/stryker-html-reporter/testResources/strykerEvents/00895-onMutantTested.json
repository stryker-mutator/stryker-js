{"sourceFilePath":"/stryker/src/isolated-runner/IsolatedTestRunnerAdapter.js","mutatorName":"BlockStatement","status":1,"replacement":"{\n}","location":{"start":{"line":9,"column":49},"end":{"line":146,"column":1}},"range":[362,6276],"originalLines":"var TestRunnerChildProcessAdapter = (function () {\r\n    function TestRunnerChildProcessAdapter(realTestRunnerName, options) {\r\n        this.realTestRunnerName = realTestRunnerName;\r\n        this.options = options;\r\n        this.startWorker();\r\n    }\r\n    TestRunnerChildProcessAdapter.prototype.startWorker = function () {\r\n        var execArgv = _.clone(process.execArgv);\r\n        _.remove(execArgv, function (arg) { return arg.substr(0, 11) === '--debug-brk'; });\r\n        this.workerProcess = child_process_1.fork(__dirname + \"/IsolatedTestRunnerAdapterWorker\", [], { silent: true, execArgv: execArgv });\r\n        this.sendStartCommand();\r\n        this.listenToWorkerProcess();\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.listenToWorkerProcess = function () {\r\n        var _this = this;\r\n        if (this.workerProcess.stdout) {\r\n            var traceEnabled_1 = log.isTraceEnabled();\r\n            this.workerProcess.stdout.on('data', function (data) {\r\n                if (traceEnabled_1) {\r\n                    log.trace(data.toString());\r\n                }\r\n            });\r\n        }\r\n        if (this.workerProcess.stderr) {\r\n            this.workerProcess.stderr.on('data', function (data) {\r\n                log.error(data.toString());\r\n            });\r\n        }\r\n        this.workerProcess.on('message', function (message) {\r\n            _this.clearCurrentTimer();\r\n            switch (message.type) {\r\n                case Message_1.MessageType.Result:\r\n                    if (!_this.isDisposing) {\r\n                        _this.handleResultMessage(message);\r\n                    }\r\n                    break;\r\n                case Message_1.MessageType.InitDone:\r\n                    _this.initPromiseFulfillmentCallback();\r\n                    break;\r\n                case Message_1.MessageType.DisposeDone:\r\n                    _this.disposePromiseFulfillmentCallback();\r\n                    break;\r\n                default:\r\n                    log.error(\"Retrieved unrecognized message from child process: \" + JSON.stringify(message));\r\n                    break;\r\n            }\r\n        });\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.init = function () {\r\n        var _this = this;\r\n        this.initPromise = new Promise(function (resolve) { return _this.initPromiseFulfillmentCallback = resolve; });\r\n        this.sendInitCommand();\r\n        return this.initPromise;\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.run = function (options) {\r\n        var _this = this;\r\n        this.clearCurrentTimer();\r\n        if (options.timeout) {\r\n            this.markNoResultTimeout(options.timeout);\r\n        }\r\n        this.runPromise = new Promise(function (resolve) {\r\n            _this.runPromiseFulfillmentCallback = resolve;\r\n            _this.sendRunCommand(options);\r\n            _this.currentRunStartedTimestamp = new Date();\r\n        });\r\n        return this.runPromise;\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.dispose = function () {\r\n        var _this = this;\r\n        if (this.isDisposing) {\r\n            return this.disposingPromise;\r\n        }\r\n        else {\r\n            this.isDisposing = true;\r\n            this.disposingPromise = new Promise(function (resolve) { return _this.disposePromiseFulfillmentCallback = resolve; })\r\n                .then(function () {\r\n                clearTimeout(timer_1);\r\n                _this.workerProcess.kill();\r\n                _this.isDisposing = false;\r\n            });\r\n            this.clearCurrentTimer();\r\n            this.sendDisposeCommand();\r\n            var timer_1 = setTimeout(this.disposePromiseFulfillmentCallback, MAX_WAIT_FOR_DISPOSE);\r\n            return this.disposingPromise;\r\n        }\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.sendRunCommand = function (options) {\r\n        var message = {\r\n            type: Message_1.MessageType.Run,\r\n            body: {\r\n                runOptions: options\r\n            }\r\n        };\r\n        this.workerProcess.send(message);\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.sendStartCommand = function () {\r\n        var startMessage = {\r\n            type: Message_1.MessageType.Start,\r\n            body: {\r\n                runnerName: this.realTestRunnerName,\r\n                runnerOptions: this.options\r\n            }\r\n        };\r\n        this.workerProcess.send(startMessage);\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.sendInitCommand = function () {\r\n        this.workerProcess.send(this.emptyMessage(Message_1.MessageType.Init));\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.sendDisposeCommand = function () {\r\n        this.workerProcess.send(this.emptyMessage(Message_1.MessageType.Dispose));\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.handleResultMessage = function (message) {\r\n        message.body.result.timeSpent = (new Date().getTime() - this.currentRunStartedTimestamp.getTime());\r\n        this.runPromiseFulfillmentCallback(message.body.result);\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.clearCurrentTimer = function () {\r\n        if (this.currentTimeoutTimer) {\r\n            clearTimeout(this.currentTimeoutTimer);\r\n        }\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.markNoResultTimeout = function (timeoutMs) {\r\n        var _this = this;\r\n        this.currentTimeoutTimer = setTimeout(function () {\r\n            _this.handleTimeout();\r\n        }, timeoutMs);\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.handleTimeout = function () {\r\n        var _this = this;\r\n        this.dispose()\r\n            .then(function () { return _this.startWorker(); })\r\n            .then(function () { return _this.init(); })\r\n            .then(function () { return _this.runPromiseFulfillmentCallback({ result: test_runner_1.TestResult.Timeout }); });\r\n    };\r\n    TestRunnerChildProcessAdapter.prototype.emptyMessage = function (type) {\r\n        return { type: type };\r\n    };\r\n    return TestRunnerChildProcessAdapter;\r\n}());","mutatedLines":"var TestRunnerChildProcessAdapter = (function () {\n}());"}